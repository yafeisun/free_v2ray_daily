name: Auto Deploy Nodes

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: pip install -r requirements.txt
    
    - name: Run collector
      run: python src/main.py --update-github
      env:
        GIT_EMAIL: ${{ secrets.GIT_EMAIL || 'action@github.com' }}
        GIT_NAME: ${{ secrets.GIT_NAME || 'GitHub Action' }}
    
    - name: Summary
      if: always()
      run: |
        echo "## 部署摘要" >> $GITHUB_STEP_SUMMARY
        echo "- **时间**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **状态**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        if [ -f result/nodelist.txt ]; then
          echo "- **节点数**: $(wc -l < result/nodelist.txt)" >> $GITHUB_STEP_SUMMARY
        fi