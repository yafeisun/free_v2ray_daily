# 每日把 result/nodetotal.txt 覆盖推送到 yafeisun/v2ray-nodes/node.txt
on:
  schedule:
    # ���天 00:00 UTC 执行；按需调整 cron 表达式（这是 UTC）
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repo (this)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run your build/script to produce result/nodetotal.txt
        # 把下面的命令替换为你仓库中实际运行生成 nodetotal 的步骤
        run: |
          # 示例：如果你有脚本 build.sh
          chmod +x ./build.sh || true
          ./build.sh || true
          # 确保生成文件路径存在
          ls -la ./result || true

      - name: Checkout target repo (yafeisun/v2ray-nodes)
        uses: actions/checkout@v4
        with:
          repository: yafeisun/v2ray-nodes
          token: ${{ secrets.TARGET_PAT }}
          path: target
          fetch-depth: 0

      - name: Copy nodetotal.txt to target repo as node.txt
        run: |
          cp -f ./result/nodetotal.txt target/node.txt
          ls -la target

      - name: Commit & push to target repo
        run: |
          cd target
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add node.txt
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update node.txt from v2raynode [skip ci]"
            git push origin HEAD:main
          fi
