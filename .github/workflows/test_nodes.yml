name: Test Nodes

on:
  schedule:
    # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡æµ‹é€Ÿ (åŒ—äº¬æ—¶é—´ 0:00, 12:00)
    - cron: '0 */12 * * *'
  
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  
  workflow_run:
    workflows: ["Update Free Nodes"]
    types:
      - completed
    branches: [main]

jobs:
  test-nodes:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2å°æ—¶è¶…æ—¶ï¼Œç»™12å°æ—¶è¿è¡Œå……è¶³æ—¶é—´
    permissions:
      contents: write
    
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install Cloudflare WARP
      run: |
        # æ·»åŠ  Cloudflare GPG å¯†é’¥
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        
        # æ·»åŠ  Cloudflare ä»“åº“
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ jammy main' | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
        
        # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£… warp-cli
        sudo apt-get update
        sudo apt-get install -y cloudflare-warp
    
    - name: Connect to Cloudflare WARP
      run: |
        # å¯åŠ¨ WARP æœåŠ¡
        sudo systemctl enable --now warp-svc
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        sudo systemctl status warp-svc --no-pager || true
        
        # æ³¨å†Œ WARPï¼ˆä½¿ç”¨åŒ¿åæ¨¡å¼ï¼‰
        warp-cli --accept-tos registration new
        
        # è¿æ¥ WARP
        warp-cli --accept-tos connect
        
        # éªŒè¯è¿æ¥çŠ¶æ€
        warp-cli --accept-tos status
        
        # è·å– WARP ä»£ç†ç«¯å£ï¼ˆé€šå¸¸æ˜¯ 40000ï¼‰
        echo "WARP ä»£ç†å·²å¯ç”¨ï¼ŒSOCKS5 ç«¯å£: 40000"
    
    - name: Cache subs-check binary
      id: cache-subscheck
      uses: actions/cache@v3
      with:
        path: subscheck/bin/subs-check
        key: subs-check-${{ runner.os }}-${{ runner.arch }}-v1
    
    - name: Install subs-check
      if: steps.cache-subscheck.outputs.cache-hit != 'true'
      run: |
        echo "å®‰è£…subs-checkå·¥å…·..."
        chmod +x scripts/convert_nodes_to_subscription.py
        chmod +x scripts/test_nodes_with_subscheck.py
        
        # æ‰‹åŠ¨ä¸‹è½½subs-check
        mkdir -p subscheck/bin
        cd subscheck/bin
        
        echo "ä¸‹è½½subs-check..."
        wget --timeout=300 --tries=3 https://github.com/beck-8/subs-check/releases/latest/download/subs-check_Linux_x86_64.tar.gz -O subs-check.tar.gz
        
        echo "è§£å‹subs-check..."
        tar -xzf subs-check.tar.gz
        
        echo "è®¾ç½®æ‰§è¡Œæƒé™..."
        chmod +x subs-check
        
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f subs-check.tar.gz
        
        echo "subs-checkå®‰è£…å®Œæˆ"
        ls -lh subs-check
    
    - name: Test nodes with subs-check
      id: tester
      run: |
        echo "å¼€å§‹èŠ‚ç‚¹æµ‹è¯•..."
        echo "ğŸ”¥ å®šæ—¶æµ‹é€Ÿç­–ç•¥ (æ¯12å°æ—¶ä¸€æ¬¡):"
        echo "  - ä½¿ç”¨ä¸¤é˜¶æ®µæµ‹è¯•æ–¹æ¡ˆï¼Œä¼˜åŒ–å¹¶å‘é¿å…å¡æ­»"
        echo "  - é˜¶æ®µ1: è¿é€šæ€§æµ‹è¯•ï¼ˆç¦ç”¨åª’ä½“æ£€æµ‹ï¼Œä¼˜åŒ–å¹¶å‘8ï¼‰"
        echo "  - é˜¶æ®µ2: åª’ä½“æ£€æµ‹ï¼ˆåªæ£€æµ‹openaiå’Œgeminiï¼Œä¼˜åŒ–å¹¶å‘5ï¼‰"
        echo "  - æ ‡å‡†è¶…æ—¶ï¼šé˜¶æ®µ1é™é»˜60ç§’ç»“æŸï¼Œé˜¶æ®µ2é™é»˜120ç§’ç»“æŸ"
        echo "  - ç­›é€‰è§„åˆ™ï¼šGPTæˆ–Geminiè‡³å°‘é€šè¿‡1ä¸ªï¼ˆ2é€‰1ï¼‰"
        echo "  - ä¼˜åŒ–ï¼šå‚è€ƒSubsCheckæ ‡å‡†é…ç½®ï¼Œå¹³è¡¡é€Ÿåº¦ä¸ç¨³å®šæ€§"
        echo "  - é¢‘ç‡ï¼šæ¯12å°æ—¶è‡ªåŠ¨è¿è¡Œ + æ‰‹åŠ¨è§¦å‘"

        # è·å–èŠ‚ç‚¹æ•°
        if [ -f result/nodetotal.txt ]; then
          total_nodes=$(wc -l < result/nodetotal.txt)
          echo "  - èŠ‚ç‚¹æ€»æ•°: $total_nodes"
        else
          total_nodes=0
        fi

        # ä½¿ç”¨ä¸¤é˜¶æ®µæµ‹è¯•è„šæœ¬
        python3 scripts/test_nodes_with_subscheck.py --input result/nodetotal.txt --output result/nodelist.txt

        echo "èŠ‚ç‚¹æµ‹è¯•å®Œæˆ"
      continue-on-error: true
    
    - name: Check for changes
      id: changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶çŠ¶æ€..."
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f result/nodelist.txt ]; then
          echo "result/nodelist.txt å­˜åœ¨"
          node_count=$(wc -l < result/nodelist.txt)
          echo "æœ‰æ•ˆèŠ‚ç‚¹æ•°: $node_count"
          echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -5 result/nodelist.txt || echo "æ— æ³•é¢„è§ˆ"
        else
          echo "result/nodelist.txt ä¸å­˜åœ¨"
          node_count=0
        fi
        
        echo ""
        echo "Git çŠ¶æ€:"
        git status
        
        echo ""
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        if git diff --quiet HEAD -- result/nodelist.txt; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°èŠ‚ç‚¹æ›´æ–°"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°èŠ‚ç‚¹æ›´æ–°"
          echo "å˜æ›´è¯¦æƒ…:"
          git diff HEAD -- result/nodelist.txt || echo "æ— æ³•æ˜¾ç¤ºå˜æ›´"
        fi
    
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
        git add result/nodelist.txt
        
        # è·å–èŠ‚ç‚¹æ•°é‡ç”¨äºæäº¤ä¿¡æ¯
        if [ -f result/nodelist.txt ]; then
          valid_count=$(wc -l < result/nodelist.txt)
        else
          valid_count=0
        fi
        
        if [ -f result/nodetotal.txt ]; then
          total_count=$(wc -l < result/nodetotal.txt)
        else
          total_count=0
        fi
        
        # ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯
        git commit -m "èŠ‚ç‚¹æµ‹è¯• - èŠ‚ç‚¹æ€»æ•°:${total_count} æœ‰æ•ˆèŠ‚ç‚¹:${valid_count} é€šè¿‡ç‡:$(echo "scale=1; ${valid_count} * 100 / ${total_count}" | bc)%"
        
        git push
        
        echo "æµ‹é€Ÿç»“æœå·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"
    
    - name: Create summary
      if: always()
      run: |
        echo "## èŠ‚ç‚¹æµ‹é€Ÿæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo "- **æ›´æ–°çŠ¶æ€**: âœ… æˆåŠŸæ›´æ–°" >> $GITHUB_STEP_SUMMARY
          if [ -f result/nodelist.txt ]; then
            valid_count=$(wc -l < result/nodelist.txt)
            echo "- **æœ‰æ•ˆèŠ‚ç‚¹æ•°**: $valid_count" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f result/nodetotal.txt ]; then
            total_count=$(wc -l < result/nodetotal.txt)
            echo "- **åŸå§‹èŠ‚ç‚¹æ•°**: $total_count" >> $GITHUB_STEP_SUMMARY
            if [ -f result/nodelist.txt ]; then
              success_rate=$(echo "scale=1; $valid_count * 100 / $total_count" | bc)
              echo "- **æˆåŠŸç‡**: $success_rate%" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æµ‹è¯•ç­–ç•¥**:" >> $GITHUB_STEP_SUMMARY
          echo "- ä½¿ç”¨subs-checkå·¥å…·è¿›è¡ŒçœŸå®çš„ä»£ç†æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•èŠ‚ç‚¹è¿é€šæ€§ã€é€Ÿåº¦å’Œæµåª’ä½“è§£é”èƒ½åŠ›" >> $GITHUB_STEP_SUMMARY
          echo "- æ”¯æŒçš„æµåª’ä½“å¹³å°: YouTube, Netflix, OpenAI, Gemini" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æ›´æ–°çŠ¶æ€**: â„¹ï¸ æ— æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.tester.outcome }}" != "success" ]; then
          echo "- **æµ‹é€ŸçŠ¶æ€**: âš ï¸ æµ‹é€Ÿè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ èŠ‚ç‚¹æµ‹é€Ÿå¤±è´¥"
        echo "è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
        exit 1