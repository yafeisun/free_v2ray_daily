name: Test Nodes

on:
  workflow_run:
    workflows: ["Update Free Nodes"]
    types:
      - completed
    branches: [main]
  
  workflow_dispatch:  # 允许手动触发

jobs:
  test-nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install Cloudflare WARP
      run: |
        # 添加 Cloudflare GPG 密钥
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        
        # 添加 Cloudflare 仓库
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ jammy main' | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
        
        # 更新包列表并安装 warp-cli
        sudo apt-get update
        sudo apt-get install -y cloudflare-warp
    
    - name: Connect to Cloudflare WARP
      run: |
        # 启动 WARP 服务
        sudo systemctl enable --now warp-svc
        
        # 等待服务启动
        sleep 10
        
        # 检查服务状态
        sudo systemctl status warp-svc --no-pager || true
        
        # 注册 WARP（使用匿名模式）
        warp-cli --accept-tos registration new
        
        # 连接 WARP
        warp-cli --accept-tos connect
        
        # 验证连接状态
        warp-cli --accept-tos status
        
        # 获取 WARP 代理端口（通常是 40000）
        echo "WARP 代理已启用，SOCKS5 端口: 40000"
    
    - name: Test nodes
      id: tester
      run: |
        echo "开始节点处理..."
        echo "注意: V2Ray/Trojan节点不是HTTP代理服务器，无法通过HTTP代理方式测试"
        echo "直接保存所有节点，用户可以使用V2Ray客户端测试节点的可用性"
        python3 scripts/test_nodes.py --input result/nodetotal.txt --output result/nodelist.txt --skip-test
        echo "节点处理完成"
      continue-on-error: true
    
    - name: Check for changes
      id: changes
      run: |
        echo "检查文件状态..."
        
        # 检查文件是否存在
        if [ -f result/nodelist.txt ]; then
          echo "result/nodelist.txt 存在"
          node_count=$(wc -l < result/nodelist.txt)
          echo "有效节点数: $node_count"
          echo "文件内容预览:"
          head -5 result/nodelist.txt || echo "无法预览"
        else
          echo "result/nodelist.txt 不存在"
          node_count=0
        fi
        
        echo ""
        echo "Git 状态:"
        git status
        
        echo ""
        echo "检查文件变更..."
        if git diff --quiet HEAD -- result/nodelist.txt; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "没有检测到节点更新"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "检测到节点更新"
          echo "变更详情:"
          git diff HEAD -- result/nodelist.txt || echo "无法显示变更"
        fi
    
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # 添加文件到暂存区
        git add result/nodelist.txt
        
        # 获取节点数量用于提交信息
        if [ -f result/nodelist.txt ]; then
          valid_count=$(wc -l < result/nodelist.txt)
        else
          valid_count=0
        fi
        
        if [ -f result/nodetotal.txt ]; then
          total_count=$(wc -l < result/nodetotal.txt)
        else
          total_count=0
        fi
        
        # 生成详细的提交信息
        commit_lines=["节点更新 - $(date '+%Y-%m-%d %H:%M:%S')"]
        commit_lines.append("=" * 60)
        commit_lines.append("")
        commit_lines.append("更新结果:")
        commit_lines.append("节点总数: $total_count")
        commit_lines.append("")
        commit_lines.append("说明:")
        commit_lines.append("- V2Ray/Trojan节点不是HTTP代理服务器")
        commit_lines.append("- 无法通过HTTP代理方式测试节点可用性")
        commit_lines.append("- 建议使用V2Ray客户端测试节点的可用性")
        
        # 组合提交信息
        commit_msg=$(printf '%s\n' "${commit_lines[@]}")
        
        git commit -m "$commit_msg"
        git push
        
        echo "测速结果已提交并推送到仓库"
    
    - name: Create summary
      if: always()
      run: |
        echo "## 节点测速摘要" >> $GITHUB_STEP_SUMMARY
        echo "- **更新时间**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **触发方式**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo "- **更新状态**: ✅ 成功更新" >> $GITHUB_STEP_SUMMARY
          if [ -f result/nodelist.txt ]; then
            node_count=$(wc -l < result/nodelist.txt)
            echo "- **节点总数**: $node_count" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**说明**:" >> $GITHUB_STEP_SUMMARY
          echo "- V2Ray/Trojan节点不是HTTP代理服务器" >> $GITHUB_STEP_SUMMARY
          echo "- 无法通过HTTP代理方式测试节点可用性" >> $GITHUB_STEP_SUMMARY
          echo "- 建议使用V2Ray客户端测试节点的可用性" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **更新状态**: ℹ️ 无更新" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.tester.outcome }}" != "success" ]; then
          echo "- **测速状态**: ⚠️ 测速过程中出现错误" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ 节点测速失败"
        echo "请检查日志以获取详细信息"
        exit 1