name: Test Nodes

on:
  workflow_run:
    workflows: ["Update Free Nodes"]
    types:
      - completed
    branches: [main]
  
  workflow_dispatch:  # 允许手动触发

jobs:
  test-nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install Cloudflare WARP
      run: |
        # 添加 Cloudflare GPG 密钥
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        
        # 添加 Cloudflare 仓库
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ jammy main' | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
        
        # 更新包列表并安装 warp-cli
        sudo apt-get update
        sudo apt-get install -y cloudflare-warp
    
    - name: Connect to Cloudflare WARP
      run: |
        # 启动 WARP 服务
        sudo systemctl enable --now warp-svc
        
        # 等待服务启动
        sleep 10
        
        # 检查服务状态
        sudo systemctl status warp-svc --no-pager || true
        
        # 注册 WARP（使用匿名模式）
        warp-cli --accept-tos registration new
        
        # 连接 WARP
        warp-cli --accept-tos connect
        
        # 验证连接状态
        warp-cli --accept-tos status
        
        # 获取 WARP 代理端口（通常是 40000）
        echo "WARP 代理已启用，SOCKS5 端口: 40000"
    
    - name: Cache subs-check binary
      id: cache-subscheck
      uses: actions/cache@v3
      with:
        path: subscheck/bin/subs-check
        key: subs-check-${{ runner.os }}-${{ runner.arch }}-v1
    
    - name: Install subs-check
      if: steps.cache-subscheck.outputs.cache-hit != 'true'
      run: |
        echo "安装subs-check工具..."
        chmod +x scripts/convert_nodes_to_subscription.py
        chmod +x scripts/test_nodes_with_subscheck.py
        
        # 手动下载subs-check
        mkdir -p subscheck/bin
        cd subscheck/bin
        
        echo "下载subs-check..."
        wget --timeout=300 --tries=3 https://github.com/beck-8/subs-check/releases/latest/download/subs-check_Linux_x86_64.tar.gz -O subs-check.tar.gz
        
        echo "解压subs-check..."
        tar -xzf subs-check.tar.gz
        
        echo "设置执行权限..."
        chmod +x subs-check
        
        echo "清理临时文件..."
        rm -f subs-check.tar.gz
        
        echo "subs-check安装完成"
        ls -lh subs-check
    
    - name: Test nodes with subs-check
      id: tester
      run: |
        echo "开始节点测试..."
        echo "测试策略:"
        echo "  - 使用分批测试脚本，每批100个节点"
        echo "  - 2个批次并发处理"
        echo "  - 超时时间10秒，并发数5"
        echo "  - 筛选规则：GPT或Gemini至少通过1个（2选1）"
        echo "  - 测试节点连通性、速度和流媒体解锁能力"
        echo "  - 支持的流媒体平台: YouTube, OpenAI, Gemini"
        
        # 使用新的分批测试脚本
        python3 scripts/test_nodes_batch.py --input result/nodetotal.txt --output result/nodelist.txt --batch-size 100 --max-workers 2
        
        echo "节点测试完成"
      continue-on-error: true
    
    - name: Check for changes
      id: changes
      run: |
        echo "检查文件状态..."
        
        # 检查文件是否存在
        if [ -f result/nodelist.txt ]; then
          echo "result/nodelist.txt 存在"
          node_count=$(wc -l < result/nodelist.txt)
          echo "有效节点数: $node_count"
          echo "文件内容预览:"
          head -5 result/nodelist.txt || echo "无法预览"
        else
          echo "result/nodelist.txt 不存在"
          node_count=0
        fi
        
        echo ""
        echo "Git 状态:"
        git status
        
        echo ""
        echo "检查文件变更..."
        if git diff --quiet HEAD -- result/nodelist.txt; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "没有检测到节点更新"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "检测到节点更新"
          echo "变更详情:"
          git diff HEAD -- result/nodelist.txt || echo "无法显示变更"
        fi
    
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # 添加文件到暂存区
        git add result/nodelist.txt
        
        # 获取节点数量用于提交信息
        if [ -f result/nodelist.txt ]; then
          valid_count=$(wc -l < result/nodelist.txt)
        else
          valid_count=0
        fi
        
        if [ -f result/nodetotal.txt ]; then
          total_count=$(wc -l < result/nodetotal.txt)
        else
          total_count=0
        fi
        
        # 生成详细的提交信息
        git commit -m "节点测试 - 节点总数:${total_count} 有效节点:${valid_count} 通过率:$(echo "scale=1; ${valid_count} * 100 / ${total_count}" | bc)%"
        
        git push
        
        echo "测速结果已提交并推送到仓库"
    
    - name: Create summary
      if: always()
      run: |
        echo "## 节点测速摘要" >> $GITHUB_STEP_SUMMARY
        echo "- **更新时间**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **触发方式**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo "- **更新状态**: ✅ 成功更新" >> $GITHUB_STEP_SUMMARY
          if [ -f result/nodelist.txt ]; then
            valid_count=$(wc -l < result/nodelist.txt)
            echo "- **有效节点数**: $valid_count" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f result/nodetotal.txt ]; then
            total_count=$(wc -l < result/nodetotal.txt)
            echo "- **原始节点数**: $total_count" >> $GITHUB_STEP_SUMMARY
            if [ -f result/nodelist.txt ]; then
              success_rate=$(echo "scale=1; $valid_count * 100 / $total_count" | bc)
              echo "- **成功率**: $success_rate%" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**测试策略**:" >> $GITHUB_STEP_SUMMARY
          echo "- 使用subs-check工具进行真实的代理测试" >> $GITHUB_STEP_SUMMARY
          echo "- 测试节点连通性、速度和流媒体解锁能力" >> $GITHUB_STEP_SUMMARY
          echo "- 支持的流媒体平台: YouTube, Netflix, OpenAI, Gemini" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **更新状态**: ℹ️ 无更新" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.tester.outcome }}" != "success" ]; then
          echo "- **测速状态**: ⚠️ 测速过程中出现错误" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ 节点测速失败"
        echo "请检查日志以获取详细信息"
        exit 1